import pandas as pd
from sqlalchemy import create_engine
import seaborn as sns
import matplotlib.pyplot as plt
from kmodes.kprototypes import KPrototypes

# PostgreSQL connection string from DBT example
db_connection_url = "(Use your postgres creds)"

# Create SQLAlchemy engine
engine = create_engine(db_connection_url)

# Test connection and list the tables
tables = pd.read_sql("SELECT table_name FROM information_schema.tables WHERE table_schema='public'", engine)
print(tables)

# Query sales data
rate_query = '''
SELECT 
    "REGION",
    "STATE",
    AVG(growth_rate_2021_2020) AS avg_growth_rate_2021_2020,
    AVG(growth_rate_2022_2021) AS avg_growth_rate_2022_2021,
    AVG(growth_rate_2023_2022) AS avg_growth_rate_2023_2022
FROM growth_rate
GROUP BY "REGION", "STATE";
'''
df = pd.read_sql(rate_query, engine)

# Display the first few rows
print(df.head())

df_encoded = pd.get_dummies(df, columns=['REGION', 'STATE'], drop_first=True)

X = df_encoded.drop(columns=['avg_growth_rate_2023_2022'])
y = df_encoded['avg_growth_rate_2023_2022']

model.fit(X, y)

