import pandas as pd
from sqlalchemy import create_engine
import seaborn as sns
import matplotlib.pyplot as plt
from kmodes.kprototypes import KPrototypes

# PostgreSQL connection string from DBT example
db_connection_url = "(Use your postgres creds)"

# Create SQLAlchemy engine
engine = create_engine(db_connection_url)

# Test connection and list the tables
tables = pd.read_sql("SELECT table_name FROM information_schema.tables WHERE table_schema='public'", engine)
print(tables)

# Query sales data
rate_query = '''
SELECT 
    "REGION",
    "NAME",
    AVG(growth_rate_2021_2020) AS avg_growth_rate_2021_2020,
    AVG(growth_rate_2022_2021) AS avg_growth_rate_2022_2021,
    AVG(growth_rate_2023_2022) AS avg_growth_rate_2023_2022
FROM growth_rate
GROUP BY "REGION", "NAME";
'''
df = pd.read_sql(rate_query, engine)

df['REGION']=df['REGION'].astype('category')

# One-hot encode REGION
df_encoded = pd.get_dummies(df, columns=['REGION'], drop_first=True)

# Define features and target
X = df_encoded.drop(columns=['avg_growth_rate_2023_2022'])
y = df_encoded['avg_growth_rate_2023_2022']

# Fit regression model
from sklearn.linear_model import LinearRegression

model = LinearRegression()
model.fit(X, y)

# Print R² score
print("R² score:", model.score(X, y))

